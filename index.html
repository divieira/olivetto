<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Olivetto</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='6' y='30' width='52' height='26' rx='4' fill='%23666'/><rect x='10' y='26' width='44' height='8' rx='2' fill='%23888'/><rect x='16' y='10' width='32' height='20' rx='2' fill='%23f5f5f5' stroke='%23999' stroke-width='1.5'/><line x1='20' y1='18' x2='44' y2='18' stroke='%23ccc' stroke-width='1.5'/><line x1='20' y1='23' x2='38' y2='23' stroke='%23ccc' stroke-width='1.5'/><circle cx='15' cy='38' r='3.5' fill='%23eee'/><circle cx='23' cy='38' r='3.5' fill='%23eee'/><circle cx='31' cy='38' r='3.5' fill='%23eee'/><circle cx='39' cy='38' r='3.5' fill='%23eee'/><circle cx='47' cy='38' r='3.5' fill='%23eee'/><circle cx='19' cy='46' r='3.5' fill='%23ddd'/><circle cx='27' cy='46' r='3.5' fill='%23ddd'/><circle cx='35' cy='46' r='3.5' fill='%23ddd'/><circle cx='43' cy='46' r='3.5' fill='%23ddd'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%;
    overflow: hidden;
    font-family: 'Nunito', sans-serif;
    background: #fff;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
  }

  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh;
    position: relative;
  }

  /* ── Color bar ── */
  #color-bar {
    display: flex;
    justify-content: center;
    gap: 14px;
    padding: 16px 10px 10px;
    flex-shrink: 0;
  }

  .color-dot {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: transform 0.15s, border-color 0.15s;
  }

  .color-dot:hover { transform: scale(1.15); }
  .color-dot.selected { border-color: #ccc; transform: scale(1.2); }

  /* ── Settings gear ── */
  #btn-settings {
    position: absolute;
    top: 16px;
    right: 14px;
    background: none;
    border: none;
    font-size: 22px;
    color: #ccc;
    cursor: pointer;
    z-index: 20;
    padding: 4px;
    line-height: 1;
    transition: color 0.15s;
  }
  #btn-settings:hover { color: #888; }

  /* ── Main writing area ── */
  #writing-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    cursor: text;
    position: relative;
    overflow-y: auto;
  }

  #text-display {
    font-size: min(20vw, 200px);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: center;
    word-break: break-word;
    white-space: pre-wrap;
    line-height: 1.3;
    color: #000;
    margin: auto 0;
  }

  #text-display .letter {
    display: inline-block;
    transition: opacity 0.1s;
  }

  #text-display .letter.blink {
    animation: letterBlink 0.35s ease-in-out;
  }

  @keyframes letterBlink {
    0%   { opacity: 1; transform: scale(1); }
    30%  { opacity: 0.2; transform: scale(1.15); }
    60%  { opacity: 1; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Blinking cursor */
  #cursor {
    display: inline-block;
    width: 3px;
    height: 0.9em;
    background: currentColor;
    margin-left: 2px;
    vertical-align: baseline;
    animation: cursorBlink 1s step-end infinite;
  }

  @keyframes cursorBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ── Hidden input for keyboard (dead keys + mobile) ── */
  #hidden-input {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    font-size: 16px;
    caret-color: transparent;
    z-index: 10;
  }

  /* ── Navigation ── */
  #nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px 16px;
    flex-shrink: 0;
  }

  .nav-btn {
    font-size: 44px;
    background: none;
    border: none;
    cursor: pointer;
    color: #bbb;
    padding: 12px 22px;
    border-radius: 14px;
    transition: color 0.15s, background 0.15s;
    font-family: 'Nunito', sans-serif;
    line-height: 1;
  }

  .nav-btn:hover { color: #888; background: #f0f0f0; }
  .nav-btn:disabled { opacity: 0.25; cursor: default; }
  .nav-btn:disabled:hover { background: none; color: #bbb; }

  #page-indicator {
    font-size: 16px;
    color: #ccc;
    font-weight: 700;
  }

  #btn-new-page {
    font-size: 32px;
    background: none;
    border: 2px solid #ddd;
    cursor: pointer;
    color: #bbb;
    padding: 8px 18px;
    border-radius: 12px;
    transition: color 0.15s, background 0.15s, border-color 0.15s;
    font-family: 'Nunito', sans-serif;
    line-height: 1;
  }
  #btn-new-page:hover { color: #888; background: #f0f0f0; border-color: #bbb; }

  /* ── Settings overlay ── */
  #settings-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  #settings-overlay.hidden { display: none; }

  #settings-panel {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    width: min(420px, 90vw);
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }

  .settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 700;
  }

  .settings-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    padding: 4px 8px;
    line-height: 1;
  }
  .settings-header button:hover { color: #555; }

  .settings-section {
    margin-bottom: 20px;
  }

  .settings-section label {
    display: block;
    font-size: 13px;
    font-weight: 700;
    color: #999;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .settings-section select {
    width: 100%;
    padding: 10px 12px;
    font-size: 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    background: #fff;
  }

  .settings-note {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 8px;
    line-height: 1.4;
  }

  #dict-list {
    max-height: 180px;
    overflow-y: auto;
    border: 2px solid #eee;
    border-radius: 10px;
    margin-bottom: 10px;
  }

  .dict-entry {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    border-bottom: 1px solid #f5f5f5;
    font-size: 15px;
  }
  .dict-entry:last-child { border-bottom: none; }
  .dict-entry .dict-word { font-weight: 700; flex: 1; }
  .dict-entry .dict-arrow { color: #ccc; flex-shrink: 0; }
  .dict-entry .dict-pron { flex: 1; color: #666; }
  .dict-entry button {
    background: none;
    border: none;
    color: #ddd;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    line-height: 1;
    flex-shrink: 0;
  }
  .dict-entry button:hover { color: #e53935; }

  .dict-empty {
    padding: 12px;
    text-align: center;
    color: #ccc;
    font-size: 14px;
  }

  .dict-add-row {
    display: flex;
    gap: 8px;
  }

  .dict-add-row input {
    flex: 1;
    padding: 8px 10px;
    font-size: 14px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-family: 'Nunito', sans-serif;
  }
  .dict-add-row input:focus {
    outline: none;
    border-color: #aaa;
  }

  .dict-add-row button {
    background: #43A047;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 18px;
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    line-height: 1;
    flex-shrink: 0;
  }
  .dict-add-row button:hover { background: #388E3C; }

  #settings-reset {
    width: 100%;
    padding: 10px;
    background: #f5f5f5;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    color: #888;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
  }
  #settings-reset:hover { background: #eee; border-color: #ccc; color: #666; }

  /* Allow text editing inside settings inputs */
  #settings-panel input,
  #settings-panel select {
    user-select: text;
    -webkit-user-select: text;
  }
</style>
</head>
<body>

<div id="app">
  <div id="color-bar"></div>
  <button id="btn-settings" aria-label="Configurações">&#9881;</button>

  <div id="writing-area">
    <div id="text-display"><span id="cursor"></span></div>
    <input id="hidden-input" type="text" autocapitalize="characters" autocomplete="off" autocorrect="off" spellcheck="false">
  </div>

  <div id="nav-bar">
    <button class="nav-btn" id="btn-prev" aria-label="Previous page">&#9664;</button>
    <span id="page-indicator"></span>
    <button id="btn-new-page" aria-label="New page">+</button>
    <button class="nav-btn" id="btn-next" aria-label="Next page">&#9654;</button>
  </div>

  <!-- Settings overlay -->
  <div id="settings-overlay" class="hidden">
    <div id="settings-panel">
      <div class="settings-header">
        <span>Configurações</span>
        <button id="settings-close" aria-label="Fechar">&#10005;</button>
      </div>

      <div class="settings-section">
        <label>Voz</label>
        <select id="voice-select"></select>
      </div>

      <div class="settings-section">
        <label>Dicionário de pronúncia</label>
        <div class="settings-note">Sílabas básicas (consoante + vogal) são corrigidas automaticamente.</div>
        <div id="dict-list"></div>
        <div class="dict-add-row">
          <input id="dict-word" placeholder="palavra">
          <input id="dict-pron" placeholder="pronúncia">
          <button id="dict-add-btn" aria-label="Adicionar">+</button>
        </div>
      </div>

      <div class="settings-section" style="margin-bottom:0">
        <button id="settings-reset">Restaurar padrões</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // ── Config ──
  var COLORS = [
    { name: 'red',    hex: '#E53935' },
    { name: 'green',  hex: '#43A047' },
    { name: 'blue',   hex: '#1E88E5' },
    { name: 'yellow', hex: '#FDD835' },
    { name: 'orange', hex: '#FB8C00' },
    { name: 'pink',   hex: '#EC407A' },
    { name: 'purple', hex: '#8E24AA' },
    { name: 'black',  hex: '#222222' },
  ];

  var STORAGE_KEY = 'olivetto';

  // ── TTS pronunciation overrides (word-level only) ──

  // Auto-generated: consonant+vowel syllables get accent marks so
  // the TTS reads them as syllables instead of spelling them out.
  var CONSONANTS = 'bcdfghjklmnpqrstvwxyz';
  var VOWEL_MAP = { 'a': '\u00e1', 'e': '\u00e9', 'i': '\u00ed', 'o': '\u00f4', 'u': '\u00fa' };
  // á = \u00e1, é = \u00e9, í = \u00ed, ô = \u00f4, ú = \u00fa

  // Custom word-level overrides (user-editable via settings)
  var DEFAULT_TTS_WORD_FIXES = {
    'mami':   'm\u00e1mi',
    'oliver': 'olliver',
    'tete':   'tet\u00ea',
  };

  var ttsWordFixes = {};
  var selectedVoiceName = null;

  function escapeHtml(ch) {
    if (ch === '<') return '&lt;';
    if (ch === '>') return '&gt;';
    if (ch === '&') return '&amp;';
    return ch;
  }

  function fixPronunciation(text) {
    return text.replace(/\S+/g, function (w) {
      // User dictionary takes precedence (hasOwnProperty guards against prototype keys)
      if (ttsWordFixes.hasOwnProperty(w)) return ttsWordFixes[w];
      // Auto-fix: 2-char consonant+vowel syllables
      if (w.length === 2 && CONSONANTS.indexOf(w[0]) >= 0 && VOWEL_MAP[w[1]]) {
        return w[0] + VOWEL_MAP[w[1]];
      }
      return w;
    });
  }

  // ── State ──
  var pages, currentPage, currentColor;

  function loadState() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        var s = JSON.parse(raw);
        pages = s.pages && s.pages.length ? s.pages : [''];
        currentPage = typeof s.currentPage === 'number' ? Math.min(s.currentPage, pages.length - 1) : 0;
        currentColor = s.color || COLORS[7].hex;
        ttsWordFixes = s.ttsWordFixes || copyObj(DEFAULT_TTS_WORD_FIXES);
        selectedVoiceName = s.voiceName || null;
      } else {
        resetToDefaults();
      }
    } catch (e) {
      resetToDefaults();
    }
  }

  function resetToDefaults() {
    pages = pages || [''];
    currentPage = currentPage || 0;
    currentColor = COLORS[7].hex;
    ttsWordFixes = copyObj(DEFAULT_TTS_WORD_FIXES);
    selectedVoiceName = null;
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      pages: pages,
      currentPage: currentPage,
      color: currentColor,
      ttsWordFixes: ttsWordFixes,
      voiceName: selectedVoiceName,
    }));
  }

  function copyObj(obj) {
    var r = {};
    for (var k in obj) r[k] = obj[k];
    return r;
  }

  // ── DOM refs ──
  var textDisplay = document.getElementById('text-display');
  var cursor = document.getElementById('cursor');
  var hiddenInput = document.getElementById('hidden-input');
  var colorBar = document.getElementById('color-bar');
  var btnPrev = document.getElementById('btn-prev');
  var btnNext = document.getElementById('btn-next');
  var btnNewPage = document.getElementById('btn-new-page');
  var pageIndicator = document.getElementById('page-indicator');
  var writingArea = document.getElementById('writing-area');

  // ── Auto-fit text size ──
  function autoFitText() {
    var maxPx = Math.min(window.innerWidth * 0.20, 200);
    var minPx = 24;
    var text = pages[currentPage] || '';

    if (!text) {
      textDisplay.style.fontSize = maxPx + 'px';
      return;
    }

    var available = writingArea.clientHeight;

    // Try max size first
    textDisplay.style.fontSize = maxPx + 'px';
    if (textDisplay.offsetHeight <= available) return;

    // Binary search for largest fitting size
    var lo = minPx, hi = maxPx;
    while (hi - lo > 1) {
      var mid = (lo + hi) / 2 | 0;
      textDisplay.style.fontSize = mid + 'px';
      if (textDisplay.offsetHeight <= available) {
        lo = mid;
      } else {
        hi = mid;
      }
    }

    textDisplay.style.fontSize = lo + 'px';
  }

  // ── Render ──
  function render() {
    var text = pages[currentPage] || '';

    // Build letter spans, preserving newlines
    var html = '';
    for (var i = 0; i < text.length; i++) {
      var ch = text[i];
      if (ch === '\n') {
        html += '<br>';
      } else if (ch === ' ') {
        html += ' ';
      } else {
        html += '<span class="letter">' + escapeHtml(ch) + '</span>';
      }
    }

    textDisplay.innerHTML = html;
    textDisplay.appendChild(cursor);
    textDisplay.style.color = currentColor;

    // Auto-fit text size
    autoFitText();

    // Nav
    btnPrev.disabled = currentPage === 0;
    btnNext.disabled = currentPage >= pages.length - 1;
    pageIndicator.textContent = (currentPage + 1) + ' / ' + pages.length;

    // Scroll to bottom of writing area
    writingArea.scrollTop = writingArea.scrollHeight;
  }

  // ── Color bar ──
  function buildColorBar() {
    COLORS.forEach(function (c) {
      var dot = document.createElement('div');
      dot.className = 'color-dot';
      dot.style.background = c.hex;
      if (c.hex === currentColor) dot.classList.add('selected');
      dot.addEventListener('click', function (e) {
        e.stopPropagation();
        currentColor = c.hex;
        document.querySelectorAll('.color-dot').forEach(function (d) { d.classList.remove('selected'); });
        dot.classList.add('selected');
        saveState();
        render();
        focusInput();
      });
      colorBar.appendChild(dot);
    });
  }

  // ── Speech ──
  var ptVoice = null;

  function pickVoice() {
    var voices = (window.speechSynthesis && window.speechSynthesis.getVoices()) || [];

    // If user selected a specific voice, use it
    if (selectedVoiceName) {
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].name === selectedVoiceName) {
          ptVoice = voices[i];
          return;
        }
      }
    }

    // Prefer "Google português do Brasil" specifically
    for (var i = 0; i < voices.length; i++) {
      if (voices[i].name === 'Google portugu\u00eas do Brasil') {
        ptVoice = voices[i];
        return;
      }
    }
    // Fallback: any pt-BR voice
    var candidates = [];
    for (var i = 0; i < voices.length; i++) {
      var lang = (voices[i].lang || '').replace('_', '-');
      if (lang.indexOf('pt-BR') === 0 || lang === 'pt-BR') {
        candidates.push(voices[i]);
      }
    }
    // If no pt-BR, try any pt voice
    if (candidates.length === 0) {
      for (var i = 0; i < voices.length; i++) {
        var lang = (voices[i].lang || '').replace('_', '-');
        if (lang.indexOf('pt') === 0) {
          candidates.push(voices[i]);
        }
      }
    }
    if (candidates.length > 0) ptVoice = candidates[0];
  }

  if (window.speechSynthesis) {
    pickVoice();
    window.speechSynthesis.addEventListener('voiceschanged', pickVoice);
  }

  function speak(text) {
    if (!text || !window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    pickVoice();
    var u = new SpeechSynthesisUtterance(fixPronunciation(text.toLowerCase()));
    u.lang = 'pt-BR';
    if (ptVoice) u.voice = ptVoice;
    u.rate = 0.65;
    u.pitch = 1.1;
    window.speechSynthesis.speak(u);
  }

  // ── Sound effect (ascending chime) ──
  var audioCtx = null;

  function getAudioCtx() {
    if (!audioCtx || audioCtx.state === 'closed') {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
  }

  function playChime(index) {
    try {
      var ctx = getAudioCtx();
      var baseFreq = 523.25; // C5
      var freq = baseFreq * Math.pow(2, (index * 2) / 12);

      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.18, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);

      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.25);
    } catch (e) {
      // Audio not supported
    }
  }

  // ── Word completion animation ──
  function animateWordCompletion() {
    var text = pages[currentPage] || '';
    var trimmed = text.replace(/[\s]+$/, '');
    var lastBreak = Math.max(trimmed.lastIndexOf(' '), trimmed.lastIndexOf('\n'));
    var wordStart = lastBreak + 1;
    var wordLen = trimmed.length - wordStart;

    if (wordLen === 0) return;

    var letters = textDisplay.querySelectorAll('.letter');
    var letterSpans = [];
    for (var i = letters.length - wordLen; i < letters.length; i++) {
      if (letters[i]) letterSpans.push(letters[i]);
    }

    letterSpans.forEach(function (span, i) {
      setTimeout(function () {
        span.classList.add('blink');
        playChime(i);
        span.addEventListener('animationend', function () {
          span.classList.remove('blink');
        }, { once: true });
      }, i * 120);
    });
  }

  // ── Get current word being typed ──
  function getCurrentWord() {
    var text = pages[currentPage] || '';
    if (!text) return '';
    var lastBreak = Math.max(text.lastIndexOf(' '), text.lastIndexOf('\n'));
    return text.substring(lastBreak + 1);
  }

  // ── Typing logic ──
  function handleChar(ch) {
    var upper = ch.toUpperCase();
    pages[currentPage] = (pages[currentPage] || '') + upper;
    saveState();
    render();
    var word = getCurrentWord();
    if (word) speak(word);
  }

  function handleEnter() {
    var text = pages[currentPage] || '';
    if (!text || text.endsWith('\n')) return;

    var word = getCurrentWord();
    if (word) speak(word);

    pages[currentPage] = text + '\n';
    saveState();
    render();
    animateWordCompletion();
  }

  function handleBackspace() {
    var text = pages[currentPage] || '';
    if (text.length === 0) return;
    pages[currentPage] = text.slice(0, -1);
    saveState();
    render();
    var word = getCurrentWord();
    if (word) speak(word);
  }

  // ── Keyboard handling ──
  var composing = false;

  hiddenInput.addEventListener('compositionstart', function () {
    composing = true;
  });

  hiddenInput.addEventListener('compositionend', function () {
    composing = false;
    var val = hiddenInput.value;
    hiddenInput.value = '';
    if (val) {
      for (var i = 0; i < val.length; i++) {
        handleChar(val[i]);
      }
    }
  });

  hiddenInput.addEventListener('keydown', function (e) {
    if (composing) return;
    if (e.ctrlKey || e.metaKey || e.altKey) return;

    if (e.key === 'Backspace') {
      e.preventDefault();
      handleBackspace();
    } else if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      handleEnter();
    }
  });

  hiddenInput.addEventListener('input', function () {
    if (composing) return;

    var val = hiddenInput.value;
    hiddenInput.value = '';
    if (!val) return;

    for (var i = 0; i < val.length; i++) {
      var ch = val[i];
      if (ch === '\n' || ch === ' ') {
        handleEnter();
      } else {
        handleChar(ch);
      }
    }
  });

  // Keep input focused
  function focusInput() {
    hiddenInput.focus({ preventScroll: true });
  }

  // Redirect stray keystrokes (but not when settings is open)
  document.addEventListener('keydown', function (e) {
    if (!settingsOverlay.classList.contains('hidden')) {
      if (e.key === 'Escape') closeSettings();
      return;
    }
    if (document.activeElement !== hiddenInput) {
      focusInput();
    }
  });

  writingArea.addEventListener('click', focusInput);
  writingArea.addEventListener('touchend', function (e) {
    e.preventDefault();
    focusInput();
  });

  // ── Settings panel ──
  var settingsOverlay = document.getElementById('settings-overlay');
  var voiceSelect = document.getElementById('voice-select');
  var dictList = document.getElementById('dict-list');
  var dictWordInput = document.getElementById('dict-word');
  var dictPronInput = document.getElementById('dict-pron');

  function openSettings() {
    populateVoiceSelect();
    renderDictList();
    settingsOverlay.classList.remove('hidden');
  }

  function closeSettings() {
    settingsOverlay.classList.add('hidden');
    focusInput();
  }

  function populateVoiceSelect() {
    voiceSelect.innerHTML = '';
    var auto = document.createElement('option');
    auto.value = '';
    auto.textContent = 'Autom\u00e1tico';
    voiceSelect.appendChild(auto);

    var voices = (window.speechSynthesis && window.speechSynthesis.getVoices()) || [];
    var ptVoices = [];
    var otherVoices = [];

    for (var i = 0; i < voices.length; i++) {
      var lang = (voices[i].lang || '').replace('_', '-');
      if (lang.indexOf('pt') === 0) {
        ptVoices.push(voices[i]);
      } else {
        otherVoices.push(voices[i]);
      }
    }

    if (ptVoices.length) {
      var group = document.createElement('optgroup');
      group.label = 'Portugu\u00eas';
      for (var i = 0; i < ptVoices.length; i++) {
        var opt = document.createElement('option');
        opt.value = ptVoices[i].name;
        opt.textContent = ptVoices[i].name;
        if (ptVoices[i].name === selectedVoiceName) opt.selected = true;
        group.appendChild(opt);
      }
      voiceSelect.appendChild(group);
    }

    if (otherVoices.length) {
      var group = document.createElement('optgroup');
      group.label = 'Outras';
      for (var i = 0; i < otherVoices.length; i++) {
        var opt = document.createElement('option');
        opt.value = otherVoices[i].name;
        opt.textContent = otherVoices[i].name;
        if (otherVoices[i].name === selectedVoiceName) opt.selected = true;
        group.appendChild(opt);
      }
      voiceSelect.appendChild(group);
    }
  }

  function renderDictList() {
    dictList.innerHTML = '';
    var keys = Object.keys(ttsWordFixes);
    if (keys.length === 0) {
      dictList.innerHTML = '<div class="dict-empty">Nenhuma entrada</div>';
      return;
    }
    keys.forEach(function (word) {
      var entry = document.createElement('div');
      entry.className = 'dict-entry';

      var wordSpan = document.createElement('span');
      wordSpan.className = 'dict-word';
      wordSpan.textContent = word;

      var arrow = document.createElement('span');
      arrow.className = 'dict-arrow';
      arrow.textContent = '\u2192';

      var pronSpan = document.createElement('span');
      pronSpan.className = 'dict-pron';
      pronSpan.textContent = ttsWordFixes[word];

      var delBtn = document.createElement('button');
      delBtn.textContent = '\u2715';
      delBtn.setAttribute('aria-label', 'Remover');
      delBtn.addEventListener('click', function () {
        delete ttsWordFixes[word];
        saveState();
        renderDictList();
      });

      entry.appendChild(wordSpan);
      entry.appendChild(arrow);
      entry.appendChild(pronSpan);
      entry.appendChild(delBtn);
      dictList.appendChild(entry);
    });
  }

  function addDictEntry() {
    var word = dictWordInput.value.trim().toLowerCase();
    var pron = dictPronInput.value.trim();
    if (word && pron) {
      ttsWordFixes[word] = pron;
      saveState();
      renderDictList();
      dictWordInput.value = '';
      dictPronInput.value = '';
      dictWordInput.focus();
    }
  }

  document.getElementById('btn-settings').addEventListener('click', function (e) {
    e.stopPropagation();
    openSettings();
  });

  document.getElementById('settings-close').addEventListener('click', closeSettings);

  settingsOverlay.addEventListener('click', function (e) {
    if (e.target === settingsOverlay) closeSettings();
  });

  voiceSelect.addEventListener('change', function () {
    selectedVoiceName = voiceSelect.value || null;
    pickVoice();
    saveState();
    speak('teste');
  });

  document.getElementById('dict-add-btn').addEventListener('click', addDictEntry);

  dictWordInput.addEventListener('keydown', function (e) {
    e.stopPropagation();
    if (e.key === 'Enter') { e.preventDefault(); addDictEntry(); }
  });
  dictPronInput.addEventListener('keydown', function (e) {
    e.stopPropagation();
    if (e.key === 'Enter') { e.preventDefault(); addDictEntry(); }
  });
  // Stop all keydowns inside settings from reaching the document handler
  document.getElementById('settings-panel').addEventListener('keydown', function (e) {
    e.stopPropagation();
    if (e.key === 'Escape') closeSettings();
  });

  document.getElementById('settings-reset').addEventListener('click', function () {
    if (!confirm('Restaurar todas as configura\u00e7\u00f5es para os valores padr\u00e3o?')) return;
    ttsWordFixes = copyObj(DEFAULT_TTS_WORD_FIXES);
    selectedVoiceName = null;
    currentColor = COLORS[7].hex;
    saveState();
    // Refresh settings UI
    populateVoiceSelect();
    renderDictList();
    // Refresh main UI
    document.querySelectorAll('.color-dot').forEach(function (d, i) {
      d.classList.toggle('selected', COLORS[i].hex === currentColor);
    });
    render();
  });

  // ── Navigation ──
  btnPrev.addEventListener('click', function (e) {
    e.stopPropagation();
    if (currentPage > 0) {
      currentPage--;
      saveState();
      render();
    }
    focusInput();
  });

  btnNext.addEventListener('click', function (e) {
    e.stopPropagation();
    if (currentPage < pages.length - 1) {
      currentPage++;
      saveState();
      render();
    }
    focusInput();
  });

  btnNewPage.addEventListener('click', function (e) {
    e.stopPropagation();
    pages.push('');
    currentPage = pages.length - 1;
    saveState();
    render();
    focusInput();
  });

  // ── Resize handler (debounced) ──
  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(autoFitText, 100);
  });

  // ── Init ──
  loadState();
  buildColorBar();
  render();

  setTimeout(focusInput, 300);
})();
</script>
</body>
</html>
